# Push Notifications System - Complete Guide

## üìã Overview

The Tiro Mo Mangaung app has a **fully implemented push notifications system** using Firebase Cloud Messaging (FCM). Notifications are sent automatically for important job-related updates.

## ‚úÖ What's Already Implemented

### 1. **Firebase Cloud Messaging (FCM) Setup**
- ‚úÖ FCM tokens are generated and saved to user documents
- ‚úÖ Token refresh handling implemented
- ‚úÖ Foreground, background, and terminated app notification handling
- ‚úÖ Local notifications for in-app display
- ‚úÖ Notification tap navigation (with data payload)

### 2. **Notification Types Currently Active**

#### For Job Seekers:
1. **New Job Posted** üéâ
   - Triggered when: An employer posts a new job
   - Sends to: All job seekers
   - Title: "New Job Posted! üéâ"
   - Body: "[Job Title] in [Location]"
   - Data: `{type: 'new_job', id: jobId, title, location}`

2. **Application Status Updates** üì¨
   - **Shortlisted**: "You've Been Shortlisted! ‚≠ê"
   - **Accepted/Hired**: "Application Accepted! üéâ"
   - **Rejected**: "Application Update"
   - **Interview Scheduled**: "Interview Scheduled! üìÖ"
   - Data: `{type: 'application_update', id: applicationId, jobId, status}`

#### For Employers:
1. **New Application Received** (To be added - see Enhancement section)
2. **Application Withdrawn** (To be added - see Enhancement section)

### 3. **Technical Architecture**

#### Files Involved:
- **`lib/services/notification_service.dart`**: Core FCM service
  - Initialize notifications
  - Handle foreground/background messages
  - Save/update FCM tokens
  - Show local notifications
  - Manage notification center (Firestore collection)

- **`lib/providers/job_provider.dart`**: Job notifications
  - `_notifyJobSeekers()` method (line 457-492)
  - Called automatically when new job is posted

- **`lib/providers/application_provider.dart`**: Application notifications
  - `updateApplicationStatus()` method (line 171-262)
  - Sends notifications based on status change
  - Customized messages per status

- **`lib/providers/auth_provider.dart`**: Token management
  - Saves FCM token during registration (line 79-91)
  - Updates token after login (line 119-127)

## üèóÔ∏è How It Works

### User Registration/Login Flow:
```
1. User registers/logs in
   ‚Üì
2. FCM token generated by Firebase
   ‚Üì
3. Token saved to user document: users/{userId}/fcmTokens (array)
   ‚Üì
4. Token refresh listener active (auto-updates on change)
```

### New Job Posted Flow:
```
1. Employer posts job via PostJobScreen
   ‚Üì
2. JobProvider.createJob() called
   ‚Üì
3. Job document created in Firestore
   ‚Üì
4. _notifyJobSeekers() triggered automatically
   ‚Üì
5. Queries all users with userType='job_seeker'
   ‚Üì
6. Calls NotificationService.sendNotificationToUser() for each
   ‚Üì
7. Notification saved to 'notifications' collection
   ‚Üì
8. (Cloud Function sends actual push - see Enhancement section)
```

### Application Status Update Flow:
```
1. Employer updates application status
   ‚Üì
2. ApplicationProvider.updateApplicationStatus() called
   ‚Üì
3. Application document updated in Firestore
   ‚Üì
4. Gets job title and seeker ID
   ‚Üì
5. Builds notification message based on status:
   - shortlisted ‚Üí "You've Been Shortlisted! ‚≠ê"
   - accepted ‚Üí "Application Accepted! üéâ"
   - rejected ‚Üí "Application Update"
   - hired ‚Üí "Congratulations! You got the job! üéâ"
   ‚Üì
6. Calls NotificationService.sendNotificationToUser()
   ‚Üì
7. Notification saved to Firestore
   ‚Üì
8. (Cloud Function sends push - see Enhancement section)
```

## üì± Notification Handling States

### 1. **Foreground** (App Open)
- Handled by: `FirebaseMessaging.onMessage.listen()`
- Location: `notification_service.dart` line 74-86
- Behavior: Shows local notification banner

### 2. **Background** (App Minimized)
- Handled by: `_firebaseMessagingBackgroundHandler`
- Location: `notification_service.dart` line 8-11
- Behavior: System notification appears

### 3. **Terminated** (App Closed)
- Handled by: `FirebaseMessaging.getInitialMessage()`
- Location: `notification_service.dart` line 95-100
- Behavior: Opens app and navigates to content

### 4. **Notification Tapped**
- Handled by: `_onNotificationTapped()`
- Location: `notification_service.dart` line 159-165
- Behavior: Navigates based on data payload

## üóÑÔ∏è Firestore Collections

### `notifications` Collection
```javascript
{
  "userId": "seeker123",
  "title": "New Job Posted! üéâ",
  "body": "Software Developer in Bloemfontein",
  "data": {
    "type": "new_job",
    "id": "job456",
    "title": "Software Developer",
    "location": "Bloemfontein"
  },
  "read": false,
  "createdAt": Timestamp
}
```

### `users` Collection (FCM Tokens)
```javascript
{
  "email": "john@example.com",
  "fullName": "John Doe",
  "userType": "job_seeker",
  "fcmTokens": [
    "fJHxKq8...", // Current device token
    "gKJwLr9..."  // Another device (if multi-device)
  ],
  "lastTokenUpdate": Timestamp
}
```

## üöÄ Testing the Notification System

### Test 1: New Job Posted Notification

**Prerequisites:**
- Two accounts: 1 employer, 1 job seeker
- Both logged in with notifications enabled

**Steps:**
1. Log in as **job seeker** on Device 1
2. Log in as **employer** on Device 2
3. On Device 2 (employer):
   - Navigate to "Post Job" screen
   - Fill in job details
   - Tap "Post Job"
4. Wait 2-5 seconds
5. **Expected**: Device 1 (job seeker) receives notification:
   - Title: "New Job Posted! üéâ"
   - Body: "[Job Title] in [Location]"
   - Tap notification ‚Üí navigates to job detail

**Console Logs to Check:**
```
I/flutter: ‚úÖ Notified X job seekers about new job
I/flutter: üì® Foreground message received: New Job Posted! üéâ
```

### Test 2: Application Status Update Notification

**Scenario A: Shortlisted**
1. Job seeker applies to a job
2. Employer navigates to Applications tab
3. Employer taps application ‚Üí taps "Shortlist"
4. **Expected**: Job seeker receives:
   - Title: "You've Been Shortlisted! ‚≠ê"
   - Body: "Good news! You've been shortlisted for [Job Title]."

**Scenario B: Accepted/Hired**
1. Employer changes status to "Hired"
2. **Expected**: Job seeker receives:
   - Title: "Application Accepted! üéâ"
   - Body: "Congratulations! Your application for [Job Title] has been accepted."

**Scenario C: Rejected**
1. Employer changes status to "Rejected"
2. **Expected**: Job seeker receives:
   - Title: "Application Update"
   - Body: "Your application for [Job Title] has been reviewed."

### Test 3: Notification Tap Navigation

**Steps:**
1. Receive a "New Job" notification
2. **Tap notification**
3. **Expected**: App opens to Job Detail screen for that job

**Current Status**: Navigation handlers are defined but may need route implementation
- See: `notification_service.dart` line 169-188

### Test 4: Multi-Device Token Management

**Steps:**
1. Log in on Device 1 ‚Üí token saved
2. Log in on Device 2 ‚Üí new token added to array
3. Post a job
4. **Expected**: Both devices receive notification

## ‚öôÔ∏è Configuration Files

### Android Manifest
**File**: `android/app/src/main/AndroidManifest.xml`
- ‚úÖ Internet permission enabled
- ‚úÖ Firebase services configured via `google-services.json`

### iOS Configuration
**File**: `ios/Runner/GoogleService-Info.plist`
- ‚úÖ Firebase services configured

### Firebase Options
**File**: `lib/firebase_options.dart`
- ‚úÖ Auto-generated, includes `messagingSenderId`

## üîß Enhancement: Cloud Functions (Recommended)

### Current Limitation
The `NotificationService.sendNotificationToUser()` method **saves notifications to Firestore** but **does not send actual push messages**. The comment at line 216 states:

```dart
// Note: Actual push notification sending should be done from Cloud Functions
// This is just storing the notification in Firestore
```

### Why Cloud Functions?
- **Security**: Server-side key not exposed in app
- **Reliability**: Guaranteed delivery
- **Scalability**: Handles thousands of users
- **Advanced Features**: Batch sending, scheduling, retry logic

### Recommended Implementation

#### 1. Create Cloud Function
**File**: `functions/src/index.ts`

```typescript
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

admin.initializeApp();

export const sendPushNotification = functions.firestore
  .document('notifications/{notificationId}')
  .onCreate(async (snapshot, context) => {
    const notification = snapshot.data();
    const userId = notification.userId;
    
    // Get user's FCM tokens
    const userDoc = await admin.firestore()
      .collection('users')
      .doc(userId)
      .get();
    
    const tokens = userDoc.data()?.fcmTokens || [];
    
    if (tokens.length === 0) {
      console.log('No tokens for user:', userId);
      return null;
    }
    
    // Send notification to all user's devices
    const message = {
      notification: {
        title: notification.title,
        body: notification.body,
      },
      data: notification.data || {},
    };
    
    try {
      const response = await admin.messaging().sendEachForMulticast({
        tokens: tokens,
        ...message,
      });
      
      console.log('Successfully sent:', response.successCount);
      console.log('Failed:', response.failureCount);
      
      // Remove invalid tokens
      if (response.failureCount > 0) {
        const tokensToRemove: string[] = [];
        response.responses.forEach((resp, idx) => {
          if (!resp.success) {
            tokensToRemove.push(tokens[idx]);
          }
        });
        
        await admin.firestore()
          .collection('users')
          .doc(userId)
          .update({
            fcmTokens: admin.firestore.FieldValue.arrayRemove(...tokensToRemove)
          });
      }
      
      return null;
    } catch (error) {
      console.error('Error sending notification:', error);
      return null;
    }
  });
```

#### 2. Deploy Cloud Function
```bash
cd functions
npm install
firebase deploy --only functions
```

#### 3. Test
- Create a notification in Firestore manually
- Cloud Function automatically triggers
- Push sent to user's devices

### Alternative: Direct FCM from App (Not Recommended)
You can send push notifications directly from the Flutter app using `http` package and FCM REST API, but this requires exposing the server key (security risk).

## üìä Monitoring & Debugging

### Console Logs
Enable debug logging to see notification flow:
```dart
debugPrint('üì± FCM Token: $token');
debugPrint('‚úÖ Token saved to Firestore');
debugPrint('üì® Foreground message received: ${message.notification?.title}');
debugPrint('üì¨ Notification opened app: ${message.notification?.title}');
debugPrint('‚úÖ Notified X job seekers about new job');
```

### Firebase Console
1. **Cloud Messaging** ‚Üí View message delivery stats
2. **Firestore** ‚Üí Check `notifications` collection
3. **Authentication** ‚Üí Verify user tokens in `fcmTokens` field

### Test Notification from Firebase Console
1. Go to Firebase Console ‚Üí Cloud Messaging
2. Click "New notification"
3. Enter title and body
4. Select target: Topic or token
5. Send test message

## üêõ Troubleshooting

### Issue: Notifications not received

**Check:**
1. ‚úÖ User has notification permission (check `AuthorizationStatus.authorized`)
2. ‚úÖ FCM token saved to Firestore (`users/{uid}/fcmTokens` array)
3. ‚úÖ App running on physical device (emulator may have issues)
4. ‚úÖ Internet connection active
5. ‚úÖ `google-services.json` file present in `android/app/`
6. ‚úÖ Firebase project has Cloud Messaging enabled

**Debug Commands:**
```dart
// Check if token exists
final token = await FirebaseMessaging.instance.getToken();
print('Token: $token');

// Check permission status
final settings = await FirebaseMessaging.instance.getNotificationSettings();
print('Permission: ${settings.authorizationStatus}');
```

### Issue: Notification appears but doesn't navigate

**Solution:**
Implement navigation handlers in `NotificationService._handleNotificationNavigation()`:

```dart
static void _handleNotificationNavigation(Map<String, dynamic> data) {
  final type = data['type'];
  final id = data['id'];
  
  switch (type) {
    case 'new_job':
      // Navigate to job detail
      navigatorKey.currentState?.push(
        MaterialPageRoute(
          builder: (_) => JobDetailScreen(jobId: id),
        ),
      );
      break;
    case 'application_update':
      // Navigate to application detail
      navigatorKey.currentState?.push(
        MaterialPageRoute(
          builder: (_) => ApplicationDetailScreen(applicationId: id),
        ),
      );
      break;
    // ... other cases
  }
}
```

**Note:** Need to add `GlobalKey<NavigatorState>` to access navigation context.

### Issue: Duplicate notifications

**Cause:** Multiple FCM tokens in array (multi-device login)

**Solution:** Already handled - tokens stored as array in Firestore, each device gets one.

## üìà Future Enhancements

### 1. **New Application Notification for Employers**
**When to send:** Job seeker submits application
**Implementation:** In `ApplicationProvider.submitApplication()`

```dart
// After creating application document
await NotificationService.sendNotificationToUser(
  userId: job.employerId,
  title: 'New Application Received! üìÑ',
  body: '${authProvider.currentUser?.fullName} applied for ${job.title}',
  data: {
    'type': 'new_application',
    'id': docRef.id,
    'jobId': jobId,
  },
);
```

### 2. **Application Withdrawn Notification**
**When to send:** Job seeker withdraws application
**Implementation:** In `ApplicationProvider.withdrawApplication()`

```dart
// After updating isWithdrawn field
final appDoc = await _firestore.collection('applications').doc(applicationId).get();
final jobId = appDoc.data()?['jobId'];
final jobDoc = await _firestore.collection('jobs').doc(jobId).get();

await NotificationService.sendNotificationToUser(
  userId: jobDoc.data()?['employerId'],
  title: 'Application Withdrawn',
  body: 'An applicant has withdrawn their application for ${jobDoc.data()?['title']}',
  data: {
    'type': 'application_withdrawn',
    'id': applicationId,
    'jobId': jobId,
  },
);
```

### 3. **Job Expiration Reminder**
**When to send:** 3 days before application deadline
**Implementation:** Cloud Function with scheduled trigger

### 4. **Nearby Jobs Alert**
**When to send:** New job posted within X km of user
**Implementation:** Use geohash queries and send targeted notifications

### 5. **In-App Notification Center**
**UI:** Badge on home screen, list of past notifications
**Implementation:** 
- Already has `notifications` collection
- Add `NotificationCenterScreen`
- Use `StreamBuilder` with `getUnreadCount()`

## ‚úÖ Summary

| Feature | Status | Location |
|---------|--------|----------|
| FCM Token Management | ‚úÖ Complete | `auth_provider.dart` |
| New Job Notifications | ‚úÖ Complete | `job_provider.dart` line 457-492 |
| Application Status Updates | ‚úÖ Complete | `application_provider.dart` line 171-262 |
| Foreground Handling | ‚úÖ Complete | `notification_service.dart` line 74-86 |
| Background Handling | ‚úÖ Complete | `notification_service.dart` line 8-11 |
| Notification Tap | ‚úÖ Complete | `notification_service.dart` line 159-165 |
| Firestore Notification Storage | ‚úÖ Complete | `notification_service.dart` line 213-227 |
| Actual Push Sending | ‚ö†Ô∏è Needs Cloud Function | See Enhancement section |
| New Application (Employer) | ‚ùå Not Implemented | See Enhancement section |
| Application Withdrawn | ‚ùå Not Implemented | See Enhancement section |

---

## üéØ Quick Start Testing

1. **Enable notifications** when prompted after login
2. **Post a job** as employer ‚Üí job seekers get notification
3. **Apply to job** as job seeker
4. **Update status** as employer ‚Üí job seeker gets notification
5. **Tap notification** ‚Üí navigates to relevant screen

All basic push notifications are working! üéâ

For production deployment, implement Cloud Functions for reliable push delivery.
